upstreams:
# Users service
  - id: 1
    type: roundrobin
    nodes:
      ${APISIX_USERS_MS_HOST}:${APISIX_USERS_MS_PORT}: 1
    retries: 2
    checks:
      active:
        timeout: 5
        http_path: /
        host: ${APISIX_USERS_MS_HOST}
        port: ${APISIX_USERS_MS_PORT}
        healthy:
          interval: 2
          successes: 1
        unhealthy:
          interval: 1
          http_failures: 2
        req_headers:
          - User-Agent: curl/7.29.0
      passive:
        healthy:
          http_statuses:
            - 200
            - 201
          successes: 3
        unhealthy:
          http_statuses:
            - 500
          http_failures: 3
          tcp_failures: 3
# Auth service
  - id: 2
    type: roundrobin
    nodes:
      ${APISIX_AUTH_MS_HOST}:${APISIX_AUTH_MS_PORT}: 1
    retries: 2
    checks:
      active:
        timeout: 5
        http_path: /
        host: ${APISIX_AUTH_MS_HOST}
        port: ${APISIX_AUTH_MS_PORT}
        healthy:
          interval: 2
          successes: 1
        unhealthy:
          interval: 1
          http_failures: 2
        req_headers:
          - User-Agent: curl/7.29.0
      passive:
        healthy:
          http_statuses:
            - 200
            - 201
          successes: 3
        unhealthy:
          http_statuses:
            - 500
          http_failures: 3
          tcp_failures: 3
# Post service
  - id: 3
    type: roundrobin
    nodes:
      ${APISIX_POSTS_MS_HOST}:${APISIX_POSTS_MS_PORT}: 1
    retries: 2
    checks:
      active:
        timeout: 5
        http_path: /
        host: ${APISIX_POSTS_MS_HOST}
        port: ${APISIX_POSTS_MS_PORT}
        healthy:
          interval: 2
          successes: 1
        unhealthy:
          interval: 1
          http_failures: 2
        req_headers:
          - User-Agent: curl/7.29.0
      passive:
        healthy:
          http_statuses:
            - 200
            - 201
          successes: 3
        unhealthy:
          http_statuses:
            - 500
          http_failures: 3
          tcp_failures: 3

routes:
# Users Service
# Users routers
  - id: 1
    methods: ["GET"]
    name: user-info
    uri: /users/info
    upstream_id: 1

  - id: 2
    methods: ["POST"]
    name: user-create
    uri: /users/create_user
    plugins:
      forward-auth:
        uri: http://${APISIX_AUTH_MS_HOST}:${APISIX_AUTH_MS_PORT}/auth/verify
        request_headers: ["Authorization"]
        upstream_headers: ["x-user-id"]
    upstream_id: 1

  - id: 3
    methods: ["PATCH"]
    name: user-update
    uri: /users/update_user_info
    plugins:
      forward-auth:
        uri: http://${APISIX_AUTH_MS_HOST}:${APISIX_AUTH_MS_PORT}/auth/verify
        request_headers: ["Authorization"]
        upstream_headers: ["x-user-id"]
    upstream_id: 1

  - id: 4
    methods: ["DELETE"]
    name: user-delete
    uri: /users/delete_user
    plugins:
      forward-auth:
        uri: http://${APISIX_AUTH_MS_HOST}:${APISIX_AUTH_MS_PORT}/auth/verify
        request_headers: ["Authorization"]
        upstream_headers: ["x-user-id"]
    upstream_id: 1

# Subscription routers
  - id: 5
    methods: ["POST"]
    name: subscription-subscribe
    uri: /subscription/subscribe
    plugins:
      forward-auth:
        uri: http://${APISIX_AUTH_MS_HOST}:${APISIX_AUTH_MS_PORT}/auth/verify
        request_headers: ["Authorization"]
        upstream_headers: ["x-user-id"]
    upstream_id: 1

  - id: 6
    methods: ["DELETE"]
    name: subscription-unsubscribe
    uri: /subscription/unsubscribe
    plugins:
      forward-auth:
        uri: http://${APISIX_AUTH_MS_HOST}:${APISIX_AUTH_MS_PORT}/auth/verify
        request_headers: ["Authorization"]
        upstream_headers: ["x-user-id"]
    upstream_id: 1

  - id: 7
    methods: ["GET"]
    name: subscription-get_subscriptions
    uri: /subscription/get_subscriptions
    upstream_id: 1

  - id: 8
    methods: ["GET"]
    name: subscription-get_subscribers
    uri: /subscription/get_subscribers
    upstream_id: 1

# Avatars routers
  - id: 9
    methods: ["POST"]
    name: avatars-set_avatar
    uri: /avatars/set_avatar
    plugins:
      forward-auth:
        uri: http://${APISIX_AUTH_MS_HOST}:${APISIX_AUTH_MS_PORT}/auth/verify
        request_headers: ["Authorization"]
        upstream_headers: ["x-user-id"]
    upstream_id: 1

  - id: 10
    methods: ["DELETE"]
    name: avatars-delete_avatar
    uri: /avatars/delete_avatar
    plugins:
      forward-auth:
        uri: http://${APISIX_AUTH_MS_HOST}:${APISIX_AUTH_MS_PORT}/auth/verify
        request_headers: ["Authorization"]
        upstream_headers: ["x-user-id"]
    upstream_id: 1

# Posts Service
# Posts routers
  - id: 11
    methods: ["GET"]
    name: posts-user_posts
    uri: /posts/user_posts
    upstream_id: 3

  - id: 12
    methods: ["GET"]
    name: posts-full_text_search
    uri: /posts/full_text_search
    upstream_id: 3

  - id: 13
    methods: ["POST"]
    name: posts-create_post
    uri: /posts/create_post
    plugins:
      forward-auth:
        uri: http://${APISIX_AUTH_MS_HOST}:${APISIX_AUTH_MS_PORT}/auth/verify
        request_headers: ["Authorization"]
        upstream_headers: ["x-user-id"]
    upstream_id: 3

  - id: 14
    methods: ["DELETE"]
    name: posts-delete_post
    uri: /posts/delete_post
    plugins:
      forward-auth:
        uri: http://${APISIX_AUTH_MS_HOST}:${APISIX_AUTH_MS_PORT}/auth/verify
        request_headers: ["Authorization"]
        upstream_headers: ["x-user-id"]
    upstream_id: 3

  - id: 15
    methods: ["PATCH"]
    name: posts-update_post
    uri: /posts/update_post
    plugins:
      forward-auth:
        uri: http://${APISIX_AUTH_MS_HOST}:${APISIX_AUTH_MS_PORT}/auth/verify
        request_headers: ["Authorization"]
        upstream_headers: ["x-user-id"]
    upstream_id: 3

# Auth Service
# Auth routes
  - id: 16
    methods: ["POST"]
    name: auth-registration
    uri: /auth/registration
    upstream_id: 2

  - id: 17
    methods: ["POST"]
    name: auth-login
    uri: /auth/login
    upstream_id: 2

  - id: 18
    methods: ["GET"]
    name: auth-refresh
    uri: /auth/refresh
    upstream_id: 2

# Auth-users routes
  - id: 19
    methods: ["PATCH"]
    name: auth-users-update_user
    uri: /auth/users/update_user
    upstream_id: 2

# Сделать путь для формирования профиля ( объединения постов и информации о пользователе )
#END
