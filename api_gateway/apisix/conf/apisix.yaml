upstreams:
  - id: 1
    type: roundrobin
    nodes:
      ${APISIX_USERS_MS_HOST}:${APISIX_USERS_MS_PORT}: 1
    retries: 2
    checks:
      active:
        timeout: 5
        http_path: /status
        host: foo.com
        healthy:
          interval: 2
          successes: 1
        unhealthy:
          interval: 1
          http_failures: 2
        req_headers:
          - User-Agent: curl/7.29.0
      passive:
        healthy:
          http_statuses:
            - 200
            - 201
          successes: 3
        unhealthy:
          http_statuses:
            - 500
          http_failures: 3
          tcp_failures: 3

  - id: 2
    type: roundrobin
    nodes:
      ${APISIX_AUTH_MS_HOST}:${APISIX_AUTH_MS_PORT}: 1
    retries: 2
    checks:
      active:
        timeout: 5
        http_path: /status
        host: foo.com
        healthy:
          interval: 2
          successes: 1
        unhealthy:
          interval: 1
          http_failures: 2
        req_headers:
          - User-Agent: curl/7.29.0
      passive:
        healthy:
          http_statuses:
            - 200
            - 201
          successes: 3
        unhealthy:
          http_statuses:
            - 500
          http_failures: 3
          tcp_failures: 3

  - id: 3
    type: roundrobin
    nodes:
      ${APISIX_POSTS_MS_HOST}:${APISIX_POSTS_MS_PORT}: 1
    retries: 2
    checks:
      active:
        timeout: 5
        http_path: /status
        host: foo.com
        healthy:
          interval: 2
          successes: 1
        unhealthy:
          interval: 1
          http_failures: 2
        req_headers:
          - User-Agent: curl/7.29.0
      passive:
        healthy:
          http_statuses:
            - 200
            - 201
          successes: 3
        unhealthy:
          http_statuses:
            - 500
          http_failures: 3
          tcp_failures: 3

routes:

# Users routers

  - id: 1
    methods: ["GET"]
    name: user-info
    uri: /users/info
    upstream_id: 1

  - id: 2
    methods: ["POST"]
    name: user-create
    uri: /users/create_user
    plugins:
      forward-auth:
        uri: http://${APISIX_AUTH_MS_HOST}:${APISIX_AUTH_MS_PORT}/auth/verify
        request_headers: ["Authorization"]
        upstream_headers: ["x-user-id"]
    upstream_id: 1

  - id: 3
    methods: ["POST"]
    name: user-update
    uri: /users/update_user_info
    plugins:
      forward-auth:
        uri: http://${APISIX_AUTH_MS_HOST}:${APISIX_AUTH_MS_PORT}/auth/verify
        request_headers: ["Authorization"]
        upstream_headers: ["x-user-id"]
    upstream_id: 1

  - id: 4
    methods: ["POST"]
    name: user-delete
    uri: /users/delete_user
    plugins:
      forward-auth:
        uri: http://${APISIX_AUTH_MS_HOST}:${APISIX_AUTH_MS_PORT}/auth/verify
        request_headers: ["Authorization"]
        upstream_headers: ["x-user-id"]
    upstream_id: 1

# Subscription routers

  - id: 5
    methods: ["POST"]
    name: subscription-subscribe
    uri: /subscription/subscribe
    plugins:
      forward-auth:
        uri: http://${APISIX_AUTH_MS_HOST}:${APISIX_AUTH_MS_PORT}/auth/verify
        request_headers: ["Authorization"]
        upstream_headers: ["x-user-id"]
    upstream_id: 1

  - id: 6
    methods: ["POST"]
    name: subscription-unsubscribe
    uri: /subscription/unsubscribe
    plugins:
      forward-auth:
        uri: http://${APISIX_AUTH_MS_HOST}:${APISIX_AUTH_MS_PORT}/auth/verify
        request_headers: ["Authorization"]
        upstream_headers: ["x-user-id"]
    upstream_id: 1

  - id: 7
    methods: ["GET"]
    name: subscription-get_subscriptions
    uri: /subscription/get_subscriptions
    upstream_id: 1

  - id: 8
    methods: ["GET"]
    name: subscription-get_subscribers
    uri: /subscription/get_subscribers
    upstream_id: 1

# Avatars routers
  - id: 9
    methods: [ "POST" ]
    name: avatars-set_avatar
    uri: /avatars/set_avatar
    plugins:
      forward-auth:
        uri: http://${APISIX_AUTH_MS_HOST}:${APISIX_AUTH_MS_PORT}/auth/verify
        request_headers: ["Authorization"]
        upstream_headers: ["x-user-id"]
    upstream_id: 1

  - id: 10
    methods: [ "POST" ]
    name: avatars-delete_avatar
    uri: /avatars/delete_avatar
    plugins:
      forward-auth:
        uri: http://${APISIX_AUTH_MS_HOST}:${APISIX_AUTH_MS_PORT}/auth/verify
        request_headers: [ "Authorization" ]
        upstream_headers: [ "x-user-id" ]
    upstream_id: 1

#END
